@page "/"
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>HengcordTCG - Web Platform</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="container py-12">
            <div class="mx-auto max-w-4xl space-y-8">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h1 class="text-3xl font-bold tracking-tight">Twój Dashboard</h1>
                        <p class="text-sm text-muted-foreground">
                            Podsumowanie Twojej ekonomii i aktywności w HengcordTCG.
                        </p>
                    </div>
                    <Badge Variant="BadgeVariant.Secondary" class="px-4 py-1 text-sm">HengcordTCG v1.0 Alpha</Badge>
                </div>

                <div class="grid gap-6 md:grid-cols-3">
                    <Card class="md:col-span-1">
                        <CardHeader>
                            <CardTitle>Saldo złota</CardTitle>
                            <CardDescription>Twoja aktualna ilość złota w grze.</CardDescription>
                        </CardHeader>
                        <CardContent>
                            @if (isBalanceLoading)
                            {
                                <div class="h-8 w-24 bg-slate-800/60 rounded animate-pulse"></div>
                            }
                            else
                            {
                                <p class="text-3xl font-extrabold text-yellow-400">@balance.ToString("N0")</p>
                            }
                        </CardContent>
                    </Card>

                    <Card class="md:col-span-2">
                        <CardHeader>
                            <CardTitle>Daily reward</CardTitle>
                            <CardDescription>Odbierz swoją dzienną nagrodę za aktywność.</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <div class="flex flex-col gap-3">
                                <div class="flex items-center gap-3">
                                    <Button Disabled="@isDailyInProgress" OnClick="ClaimDailyAsync">
                                        @(isDailyInProgress ? "Odbieranie..." : "Odbierz daily")
                                    </Button>
                                    @if (!string.IsNullOrEmpty(dailyStatus))
                                    {
                                        <span class="text-sm text-muted-foreground">@dailyStatus</span>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(dailyError))
                                {
                                    <p class="text-sm text-red-400">@dailyError</p>
                                }
                            </div>
                        </CardContent>
                    </Card>
                </div>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="container py-12">
            <div class="mx-auto max-w-4xl space-y-12">
                <!-- Hero Section -->
                <div class="text-center space-y-6">
                    <div class="flex justify-center mb-4">
                        <Badge Variant="BadgeVariant.Secondary" class="px-4 py-1 text-sm">HengcordTCG v1.0 Alpha</Badge>
                    </div>
                    <h1 class="text-5xl font-extrabold tracking-tighter sm:text-7xl bg-gradient-to-r from-primary to-blue-600 bg-clip-text text-transparent">
                        Twoje Centrum TCG
                    </h1>
                    <p class="text-xl text-muted-foreground max-w-2xl mx-auto">
                        Zarządzaj swoją kolekcją kart, handluj na rynku i sprawdzaj statystyki na żywo – wszystko w jednym, responsywnym miejscu.
                    </p>
                    <div class="flex justify-center gap-4 pt-4">
                        <Button Size="ButtonSize.Large" class="px-8" @onclick='() => Navigation.NavigateTo("collection")'>Przeglądaj Karty</Button>
                        <Button Variant="ButtonVariant.Outline" Size="ButtonSize.Large" class="px-8">Dołącz do Discorda</Button>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 pt-6">
                    <Card class="hover:border-primary/50 transition-colors shadow-lg">
                        <CardHeader>
                            <div class="p-2 w-fit rounded-lg bg-primary/10 mb-2">
                                <LucideIcon Name="layout-grid" Size="24" class="text-primary" />
                            </div>
                            <CardTitle>Album Kolekcjonera</CardTitle>
                            <CardDescription>Twoje wszystkie karty w interaktywnym widoku z filtrowaniem rzadkości.</CardDescription>
                        </CardHeader>
                    </Card>

                    <Card class="hover:border-primary/50 transition-colors shadow-lg">
                        <CardHeader>
                            <div class="p-2 w-fit rounded-lg bg-primary/10 mb-2">
                                <LucideIcon Name="shopping-cart" Size="24" class="text-primary" />
                            </div>
                            <CardTitle>Rynek (Marketplace)</CardTitle>
                            <CardDescription>Wystawiaj oferty i kupuj karty od innych graczy za walutę z gry.</CardDescription>
                        </CardHeader>
                    </Card>

                    <Card class="hover:border-primary/50 transition-colors shadow-lg">
                        <CardHeader>
                            <div class="p-2 w-fit rounded-lg bg-primary/10 mb-2">
                                <LucideIcon Name="trophy" Size="24" class="text-primary" />
                            </div>
                            <CardTitle>Rankingi Globalne</CardTitle>
                            <CardDescription>Sprawdź kto jest najbogatszym graczem i kto posiada najwięcej legend.</CardDescription>
                        </CardHeader>
                    </Card>
                </div>

                <Separator />

                <!-- Admin / Status Section -->
                <div class="grid gap-8 md:grid-cols-2 items-center py-6">
                    <div class="space-y-4">
                        <h2 class="text-3xl font-bold">Panel Zarządzania</h2>
                        <p class="text-muted-foreground">
                            Dla administratorów przygotowaliśmy zaawansowane narzędzia do edycji drop-rate'u, monitorowania błędów bota oraz tworzenia nowych kart w czasie rzeczywistym.
                        </p>
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-3">
                                <LucideIcon Name="check-circle-2" Size="18" class="text-green-500" />
                                <span>Live Card Editor z podglądem</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <LucideIcon Name="check-circle-2" Size="18" class="text-green-500" />
                                <span>Statystyki serwera na żywo</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <LucideIcon Name="check-circle-2" Size="18" class="text-green-500" />
                                <span>Dystrybucja nagród eventowych</span>
                            </div>
                        </div>
                    </div>
            
                    <Card class="bg-muted/40 border-dashed border-2">
                        <CardHeader>
                            <CardTitle class="flex items-center gap-2">
                                <LucideIcon Name="info" Size="20" /> Status Bota
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium">Baza Kart:</span>
                                    <Badge Variant="BadgeVariant.Outline">4,500+</Badge>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium">Graczy Online:</span>
                                    <div class="flex items-center gap-2">
                                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                        <span class="text-sm">Aktywny</span>
                                    </div>
                                </div>
                                <Button Variant="ButtonVariant.Secondary" class="w-full">Panel Admina</Button>
                            </div>
                        </CardContent>
                    </Card>
                </div>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private HttpClient Http { get; set; } = default!;

    private long balance;
    private bool isBalanceLoading = true;

    private bool isDailyInProgress;
    private string? dailyStatus;
    private string? dailyError;

    protected override async Task OnInitializedAsync()
    {
        await LoadBalanceAsync();
    }

    private async Task LoadBalanceAsync()
    {
        try
        {
            isBalanceLoading = true;
            var resp = await Http.GetFromJsonAsync<BalanceResponse>("/me/balance");
            if (resp is not null)
            {
                balance = resp.Balance;
            }
        }
        catch
        {
            // ignore for now
        }
        finally
        {
            isBalanceLoading = false;
        }
    }

    private async Task ClaimDailyAsync()
    {
        try
        {
            isDailyInProgress = true;
            dailyError = null;

            var response = await Http.PostAsync("/me/daily", null);
            if (!response.IsSuccessStatusCode)
            {
                dailyError = "Nie udało się odebrać daily.";
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<DailyResponse>();
            if (result is null)
            {
                dailyError = "Błąd odpowiedzi serwera.";
                return;
            }

            if (result.Success)
            {
                dailyStatus = $"Odebrano {result.Amount} złota!";
                await LoadBalanceAsync();
            }
            else if (!string.IsNullOrEmpty(result.TimeRemaining))
            {
                dailyStatus = $"Daily już odebrane. Spróbuj ponownie za {result.TimeRemaining}.";
            }
            else
            {
                dailyStatus = "Daily niedostępne.";
            }
        }
        catch
        {
            dailyError = "Wystąpił błąd podczas odbierania daily.";
        }
        finally
        {
            isDailyInProgress = false;
        }
    }

    private sealed record BalanceResponse(long Balance);
    private sealed record DailyResponse(bool Success, int Amount, string? TimeRemaining);
}
