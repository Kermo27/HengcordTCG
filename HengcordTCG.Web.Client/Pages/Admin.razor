@page "/admin"
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>Panel administratora</PageTitle>

<AuthorizeView>
    <Authorized Context="authContext">
        @{
            var isAdmin = authContext.User.HasClaim("is_admin", "true");
        }

        @if (!isAdmin)
        {
            <div class="container py-12 text-center space-y-4">
                <h1 class="text-3xl font-bold">Brak uprawnień</h1>
                <p class="text-muted-foreground">
                    Twoje konto nie ma uprawnień administratora bota HengcordTCG.
                </p>
            </div>
        }
        else
        {
            <div class="container py-8 space-y-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold tracking-tight">Panel administratora</h1>
                        <p class="text-sm text-muted-foreground">
                            Narzędzia do zarządzania ekonomią i paczkami.
                        </p>
                    </div>
                    <Badge Variant="BadgeVariant.Secondary">Admin</Badge>
                </div>

                <div class="grid gap-6 md:grid-cols-2">
                    <!-- Give gold -->
                    <Card>
                        <CardHeader>
                            <CardTitle>Nadaj złoto</CardTitle>
                            <CardDescription>
                                Dodaj złoto wybranemu użytkownikowi (Discord ID).
                            </CardDescription>
                        </CardHeader>
                        <CardContent class="space-y-3">
                            <div class="space-y-1">
                                <Label>Discord ID użytkownika</Label>
                                <Input @bind-Value="targetDiscordId" Placeholder="np. 123456789012345678" />
                            </div>
                            <div class="space-y-1">
                                <Label>Ilość złota (może być ujemna)</Label>
                                <Input @bind-Value="amountString" Placeholder="np. 100" />
                            </div>
                        </CardContent>
                        <CardFooter class="flex flex-col gap-2">
                            <Button Disabled="@isGiveGoldBusy" OnClick="GiveGoldAsync">
                                @(isGiveGoldBusy ? "Wysyłanie..." : "Nadaj złoto")
                            </Button>
                            @if (!string.IsNullOrEmpty(giveGoldStatus))
                            {
                                <p class="text-xs text-muted-foreground">@giveGoldStatus</p>
                            }
                            @if (!string.IsNullOrEmpty(giveGoldError))
                            {
                                <p class="text-xs text-red-400">@giveGoldError</p>
                            }
                        </CardFooter>
                    </Card>

                    <!-- Packs toggle -->
                    <Card>
                        <CardHeader>
                            <CardTitle>Paczki w sklepie</CardTitle>
                            <CardDescription>
                                Włączaj/wyłączaj dostępność paczek.
                            </CardDescription>
                        </CardHeader>
                        <CardContent>
                            @if (isPacksLoading)
                            {
                                <div class="space-y-2">
                                    @for (var i = 0; i < 3; i++)
                                    {
                                        <div class="h-8 bg-slate-900/60 rounded animate-pulse"></div>
                                    }
                                </div>
                            }
                            else if (!string.IsNullOrEmpty(packsError))
                            {
                                <p class="text-sm text-red-400">@packsError</p>
                            }
                            else if (packs.Count == 0)
                            {
                                <p class="text-sm text-muted-foreground">Brak zdefiniowanych paczek.</p>
                            }
                            else
                            {
                                <div class="space-y-2">
                                    @foreach (var pack in packs)
                                    {
                                        <div class="flex items-center justify-between text-sm">
                                            <div>
                                                <span class="font-medium">@pack.Name</span>
                                                <span class="text-xs text-muted-foreground ml-2">
                                                    (@(pack.IsAvailable ? "aktywna" : "wyłączona"))
                                                </span>
                                            </div>
                                            <Button Size="ButtonSize.Small" Variant="ButtonVariant.Outline"
                                                    Disabled="@isToggleBusy"
                                                    OnClick="@(() => TogglePackAsync(pack))">
                                                @(pack.IsAvailable ? "Wyłącz" : "Włącz")
                                            </Button>
                                        </div>
                                    }
                                </div>
                            }
                        </CardContent>
                    </Card>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <div class="container py-12 text-center space-y-4">
            <h1 class="text-3xl font-bold">Zaloguj się jako admin</h1>
            <p class="text-muted-foreground">
                Panel administratora jest dostępny tylko dla kont z uprawnieniami admina bota HengcordTCG.
            </p>
            <a href="/login" class="inline-flex items-center gap-2 px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-semibold rounded-lg transition-all shadow-lg shadow-indigo-600/20">
                <LucideIcon Name="log-in" Size="18" />
                Zaloguj przez Discord
            </a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    [Inject] private HttpClient Http { get; set; } = default!;

    // Give gold state
    private string? targetDiscordId;
    private string? amountString;
    private bool isGiveGoldBusy;
    private string? giveGoldStatus;
    private string? giveGoldError;

    // Packs toggle state
    private List<PackType> packs = new();
    private bool isPacksLoading = true;
    private string? packsError;
    private bool isToggleBusy;

    protected override async Task OnInitializedAsync()
    {
        await LoadPacksAsync();
    }

    private async Task LoadPacksAsync()
    {
        try
        {
            isPacksLoading = true;
            packs = await Http.GetFromJsonAsync<List<PackType>>("/shop/packs") ?? new();
        }
        catch
        {
            packsError = "Nie udało się załadować listy paczek.";
        }
        finally
        {
            isPacksLoading = false;
        }
    }

    private async Task GiveGoldAsync()
    {
        giveGoldStatus = null;
        giveGoldError = null;

        if (string.IsNullOrWhiteSpace(targetDiscordId) || string.IsNullOrWhiteSpace(amountString))
        {
            giveGoldError = "Podaj Discord ID i ilość złota.";
            return;
        }

        if (!ulong.TryParse(targetDiscordId, out var discordId))
        {
            giveGoldError = "Nieprawidłowe Discord ID.";
            return;
        }

        if (!int.TryParse(amountString, out var amount))
        {
            giveGoldError = "Nieprawidłowa ilość złota.";
            return;
        }

        try
        {
            isGiveGoldBusy = true;

            var response = await Http.PostAsync($"/admin/give-gold?discordId={discordId}&amount={amount}", null);
            if (!response.IsSuccessStatusCode)
            {
                giveGoldError = "Nie udało się nadać złota.";
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<GiveGoldResponse>();
            giveGoldStatus = result is not null
                ? $"Nowy balans użytkownika: {result.Balance} złota."
                : "Złoto nadane.";
        }
        catch
        {
            giveGoldError = "Wystąpił błąd podczas nadawania złota.";
        }
        finally
        {
            isGiveGoldBusy = false;
        }
    }

    private async Task TogglePackAsync(PackType pack)
    {
        packsError = null;

        try
        {
            isToggleBusy = true;
            var response = await Http.PostAsync($"/admin/toggle-pack?packName={Uri.EscapeDataString(pack.Name)}", null);
            if (!response.IsSuccessStatusCode)
            {
                packsError = "Nie udało się przełączyć paczki.";
                return;
            }

            // Locally flip IsActive
            pack.IsAvailable = !pack.IsAvailable;
            StateHasChanged();
        }
        catch
        {
            packsError = "Wystąpił błąd podczas przełączania paczki.";
        }
        finally
        {
            isToggleBusy = false;
        }
    }

    private sealed record GiveGoldResponse(long Balance);
}

