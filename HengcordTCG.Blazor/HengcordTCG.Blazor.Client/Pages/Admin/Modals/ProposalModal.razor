@if (Show && Proposal != null)
{
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-medium px-2 py-1 rounded @GetProposalTypeClass(Proposal.Type.ToString())">
                        @Proposal.Type.ToString()
                    </span>
                    <h3 class="text-xl font-bold text-white">Proposal Details</h3>
                </div>
                <button @onclick="OnClose" class="text-slate-400 hover:text-white">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="p-4 border-b border-slate-700 bg-slate-800/50">
                <div class="flex items-center gap-4 text-sm">
                    <span class="text-slate-400">by <span class="text-white">@Proposal.SubmittedByUsername</span></span>
                    <span class="text-slate-500">@Proposal.CreatedAt.ToString("yyyy-MM-dd HH:mm")</span>
                    @if (!string.IsNullOrEmpty(Proposal.WikiPageTitle))
                    {
                        <span class="text-slate-400">Page: <span class="text-amber-400">@Proposal.WikiPageTitle</span></span>
                    }
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                @if (Proposal.Type.ToString() == "Edit" && Proposal.Diff != null)
                {
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-medium text-red-400">
                                    <i class="fa fa-minus-circle mr-1"></i> Original
                                </h4>
                                <span class="text-xs text-slate-500">@Proposal.Diff.Left.Lines.Count lines</span>
                            </div>
                            <div class="diff-panel">
                                @foreach (var line in Proposal.Diff.Left.Lines)
                                {
                                    <div class="diff-line @GetDiffLineClass(line.Type)">
                                        @if (line.LineNumber > 0)
                                        {
                                            <span class="diff-line-number">@line.LineNumber</span>
                                        }
                                        else
                                        {
                                            <span class="diff-line-number"></span>
                                        }
                                        <span class="diff-line-prefix">@GetDiffPrefix(line.Type)</span>
                                        <span class="diff-line-content">@line.Content</span>
                                    </div>
                                }
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-medium text-emerald-400">
                                    <i class="fa fa-plus-circle mr-1"></i> Proposed
                                </h4>
                                <span class="text-xs text-slate-500">@Proposal.Diff.Right.Lines.Count lines</span>
                            </div>
                            <div class="diff-panel">
                                @foreach (var line in Proposal.Diff.Right.Lines)
                                {
                                    <div class="diff-line @GetDiffLineClass(line.Type)">
                                        @if (line.LineNumber > 0)
                                        {
                                            <span class="diff-line-number">@line.LineNumber</span>
                                        }
                                        else
                                        {
                                            <span class="diff-line-number"></span>
                                        }
                                        <span class="diff-line-prefix">@GetDiffPrefix(line.Type)</span>
                                        <span class="diff-line-content">@line.Content</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                else if (Proposal.Type.ToString() == "Delete")
                {
                    <div>
                        <h4 class="text-sm font-medium text-red-400 mb-2">
                            <i class="fa fa-trash mr-1"></i> Content to be deleted
                        </h4>
                        <div class="bg-slate-800 rounded p-4 text-slate-300 max-h-96 overflow-y-auto whitespace-pre-wrap font-mono text-sm">
                            @Proposal.Content
                        </div>
                    </div>
                }
                else
                {
                    <div>
                        <h4 class="text-sm font-medium text-emerald-400 mb-2">
                            <i class="fa fa-file-text mr-1"></i> New Page Content
                        </h4>
                        <div class="bg-slate-800 rounded p-4 text-slate-300 max-h-96 overflow-y-auto whitespace-pre-wrap font-mono text-sm">
                            @Proposal.Content
                        </div>
                    </div>
                }
            </div>
            
            <div class="p-6 border-t border-slate-700 flex justify-between items-center">
                <div class="text-sm text-slate-400">
                    <span class="text-emerald-400">+@(Proposal.Diff?.Right.Lines.Count(l => l.Type == "inserted") ?? 0)</span>
                    <span class="mx-2">|</span>
                    <span class="text-red-400">-@(Proposal.Diff?.Left.Lines.Count(l => l.Type == "deleted") ?? 0)</span>
                </div>
                <div class="flex gap-3">
                    <button @onclick="OnClose" class="bg-slate-700 px-4 py-2 rounded-lg text-white hover:bg-slate-600">Close</button>
                    <button @onclick="OnReject" class="bg-red-600 px-4 py-2 rounded-lg text-white hover:bg-red-500">
                        <i class="fa fa-times mr-2"></i> Reject
                    </button>
                    <button @onclick="OnApprove" class="bg-emerald-600 px-4 py-2 rounded-lg text-white hover:bg-emerald-500">
                        <i class="fa fa-check mr-2"></i> Approve
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (ShowRejectDialog)
{
    <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md">
            <div class="p-6 border-b border-slate-700">
                <h3 class="text-xl font-bold text-white">Reject Proposal</h3>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-slate-400">Rejecting: <span class="text-white">@Proposal?.Title</span></p>
                <div>
                    <label class="block text-slate-400 text-sm mb-1">Reason (optional)</label>
                    <textarea @bind="RejectReason" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white h-24"></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-slate-700 flex justify-end gap-3">
                <button @onclick="OnCancelReject" class="bg-slate-700 px-4 py-2 rounded-lg text-white">Cancel</button>
                <button @onclick="OnConfirmReject" class="bg-red-600 px-4 py-2 rounded-lg text-white">Reject</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public bool Show { get; set; }

    [Parameter]
    public WikiProposalListDto? Proposal { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback OnApprove { get; set; }

    [Parameter]
    public EventCallback<string> OnRejectWithReason { get; set; }

    private bool ShowRejectDialog { get; set; }
    private string RejectReason { get; set; } = "";

    private void OnReject()
    {
        ShowRejectDialog = true;
    }

    private void OnCancelReject()
    {
        ShowRejectDialog = false;
        RejectReason = "";
    }

    private async Task OnConfirmReject()
    {
        await OnRejectWithReason.InvokeAsync(RejectReason);
        ShowRejectDialog = false;
        RejectReason = "";
    }

    private string GetProposalTypeClass(string type) => type switch
    {
        "NewPage" => "bg-emerald-600/50 text-emerald-300",
        "Edit" => "bg-amber-600/50 text-amber-300",
        "Delete" => "bg-red-600/50 text-red-300",
        _ => "bg-slate-600 text-slate-300"
    };

    private string GetDiffLineClass(string type) => type switch
    {
        "deleted" => "diff-deleted",
        "inserted" => "diff-added",
        "imaginary" => "diff-imaginary",
        "modified" => "diff-modified",
        _ => "diff-unchanged"
    };

    private string GetDiffPrefix(string type) => type switch
    {
        "deleted" => "-",
        "inserted" => "+",
        _ => " "
    };
}
