@page "/shop"
@inject HengcordTCGClient Client
@inject AuthService AuthService

<PageTitle>Shop - HengcordTCG</PageTitle>

<div class="container py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Shop</h1>
        <p class="text-slate-400">Buy card packs to expand your collection</p>
    </div>

    @if (IsLoading)
    {
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            @for (int i = 0; i < 6; i++)
            {
                <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-6 animate-pulse">
                    <div class="h-48 bg-slate-800 rounded-lg mb-4"></div>
                    <div class="h-6 bg-slate-800 rounded w-3/4 mb-2"></div>
                    <div class="h-4 bg-slate-800 rounded w-1/2"></div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            @foreach (var pack in Packs.Where(p => p.IsAvailable))
            {
                <div class="bg-slate-900/50 border border-slate-800 rounded-xl overflow-hidden hover:border-amber-500/50 transition-colors">
                    <div class="h-48 bg-gradient-to-br from-amber-600 to-orange-700 flex items-center justify-center">
                        <i class="fa fa-box text-white text-6xl opacity-50"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold text-white mb-2">@pack.Name</h3>
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-2xl font-bold text-amber-400">@pack.Price.ToString("N0")</span>
                            <span class="text-amber-400"><i class="fa fa-coins"></i> Gold</span>
                        </div>
                        <button @onclick="() => BuyPack(pack)" 
                            disabled="@IsBuying"
                            class="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-medium py-3 rounded-lg disabled:opacity-50">
                            @if (IsBuying)
                            {
                                <i class="fa fa-spinner fa-spin mr-2"></i>
                            }
                            <i class="fa fa-shopping-cart mr-2"></i> Buy Pack
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<PackType> Packs { get; set; } = new();
    private bool IsLoading = true;
    private bool IsBuying;

    protected override async Task OnInitializedAsync()
    {
        await LoadPacks();
    }

    private async Task LoadPacks()
    {
        IsLoading = true;
        try
        {
            Packs = await Client.GetPacksAsync();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task BuyPack(PackType pack)
    {
        var user = await AuthService.GetCurrentUserAsync();
        if (user == null) return;

        IsBuying = true;
        try
        {
            var result = await Client.BuyPackAsync(user.Id, user.Username, pack.Name);
            if (result.success)
            {
                user.Gold -= pack.Price;
            }
        }
        finally
        {
            IsBuying = false;
        }
    }
}
