@page "/deck"
@using HengcordTCG.Shared.Clients
@using HengcordTCG.Shared.Models
@using HengcordTCG.Blazor.Client.Services

<PageTitle>Deck Builder - HengcordTCG</PageTitle>

<div class="container py-8">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">Deck Builder</h1>
            <p class="text-slate-400">Build your battle deck</p>
        </div>
        <div class="flex gap-3">
            <TcgButton Variant="Secondary" OnClick="LoadDeck">
                <i class="fa fa-rotate-right mr-2"></i> Reset
            </TcgButton>
            <TcgButton Variant="Primary" OnClick="SaveDeck" Disabled="@(!IsValid)">
                <i class="fa fa-save mr-2"></i> Save Deck
            </TcgButton>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="mb-6 p-4 rounded-lg @MessageClass">
            @Message
        </div>
    }

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Commander -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fa fa-crown text-amber-400 mr-2"></i> Commander
                </h2>
                <TcgBadge Color="@(Commander != null ? "green" : "red")">
                    @(Commander != null ? "1/1" : "0/1")
                </TcgBadge>
            </div>
            
            @if (Commander != null)
            {
                <div class="card-container rounded-xl overflow-hidden border-2 border-amber-500/50 relative group cursor-pointer" @onclick="() => OpenCardPicker(DeckSection.Commander)">
                    <img src="@GetImageUrl(Commander.ImagePath)" alt="@Commander.Name" class="card-image">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex items-end p-3">
                        <p class="text-white font-medium">@Commander.Name</p>
                    </div>
                    <button class="absolute top-2 right-2 bg-red-500/80 hover:bg-red-500 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" @onclick="() => RemoveCommander()" @onclick:stopPropagation="true">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            }
            else
            {
                <div class="aspect-[3/4] rounded-xl border-2 border-dashed border-slate-700 flex items-center justify-center cursor-pointer hover:border-amber-500/50 transition-colors" @onclick="() => OpenCardPicker(DeckSection.Commander)">
                    <div class="text-center text-slate-500">
                        <i class="fa fa-plus text-3xl mb-2"></i>
                        <p>Select Commander</p>
                    </div>
                </div>
            }
        </div>

        <!-- Main Deck -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fa fa-shield-halved text-blue-400 mr-2"></i> Main Deck
                </h2>
                <TcgBadge Color="@(MainDeck.Count == 9 ? "green" : MainDeck.Count > 9 ? "red" : "yellow")">
                    @(MainDeck.Count)/9
                </TcgBadge>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
                @for (int i = 0; i < 9; i++)
                {
                    var index = i;
                    if (index < MainDeck.Count)
                    {
                        var card = MainDeck[index];
                        <div class="card-container rounded-lg overflow-hidden border border-slate-700 relative group cursor-pointer" @onclick="() => OpenCardPicker(DeckSection.MainDeck, index)">
                            <img src="@GetImageUrl(card.ImagePath)" alt="@card.Name" class="card-image">
                            <button class="absolute top-1 right-1 bg-red-500/80 hover:bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity text-xs" @onclick="() => RemoveFromMainDeck(index)" @onclick:stopPropagation="true">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="aspect-[3/4] rounded-lg border border-dashed border-slate-700 flex items-center justify-center cursor-pointer hover:border-blue-500/50 transition-colors" @onclick="() => OpenCardPicker(DeckSection.MainDeck, index)">
                            <i class="fa fa-plus text-slate-600"></i>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Closer Deck -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fa fa-bolt text-purple-400 mr-2"></i> Closer Deck
                </h2>
                <TcgBadge Color="@(CloserDeck.Count == 3 ? "green" : CloserDeck.Count > 3 ? "red" : "yellow")">
                    @(CloserDeck.Count)/3
                </TcgBadge>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
                @for (int i = 0; i < 3; i++)
                {
                    var index = i;
                    if (index < CloserDeck.Count)
                    {
                        var card = CloserDeck[index];
                        <div class="card-container rounded-lg overflow-hidden border border-slate-700 relative group cursor-pointer" @onclick="() => OpenCardPicker(DeckSection.Closer, index)">
                            <img src="@GetImageUrl(card.ImagePath)" alt="@card.Name" class="card-image">
                            <button class="absolute top-1 right-1 bg-red-500/80 hover:bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity text-xs" @onclick="() => RemoveFromCloserDeck(index)" @onclick:stopPropagation="true">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="aspect-[3/4] rounded-lg border border-dashed border-slate-700 flex items-center justify-center cursor-pointer hover:border-purple-500/50 transition-colors" @onclick="() => OpenCardPicker(DeckSection.Closer, index)">
                            <i class="fa fa-plus text-slate-600"></i>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    @if (ShowCardPicker)
    {
        <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" @onclick="CloseCardPicker">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-4xl max-h-[80vh] overflow-hidden" @onclick:stopPropagation="true">
                <div class="p-4 border-b border-slate-700 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-white">
                        Select @PickerSectionTitle
                    </h3>
                    <button class="text-slate-400 hover:text-white" @onclick="CloseCardPicker">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-4 border-b border-slate-800">
                    <input type="text" placeholder="Search your collection..." 
                        @bind="CardSearchQuery"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-2 text-white placeholder-slate-500">
                </div>

                <div class="p-4 overflow-y-auto max-h-[60vh]">
                    @if (FilteredCollectionCards.Count == 0)
                    {
                        <div class="text-center py-8 text-slate-500">
                            <i class="fa fa-box text-4xl mb-2 block"></i>
                            <p>No cards found in your collection</p>
                        </div>
                    }
                    else
                    {
                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                            @foreach (var card in FilteredCollectionCards)
                            {
                                <div class="card-container rounded-lg overflow-hidden border-2 border-slate-700 hover:border-amber-500 cursor-pointer transition-colors relative group" @onclick="() => SelectCard(card)">
                                    @if (!string.IsNullOrEmpty(card.ImagePath))
                                    {
                                        <img src="@GetImageUrl(card.ImagePath)" alt="@card.Name" class="card-image">
                                    }
                                    else
                                    {
                                        <div class="card-container bg-gradient-to-br from-slate-600 to-slate-700 flex items-center justify-center">
                                            <i class="fa fa-image text-white opacity-30"></i>
                                        </div>
                                    }
                                    <div class="absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/90 to-transparent">
                                        <p class="text-white text-xs font-medium truncate">@card.Name</p>
                                        <p class="text-slate-400 text-xs">@card.CardType</p>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>
