@page "/deck"
@attribute [Authorize]
@inject HengcordTCGClient Client
@inject AuthService AuthService

<PageTitle>Deck Builder - HengcordTCG</PageTitle>

<div class="container py-8">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white mb-2">Deck Builder</h1>
            <p class="text-slate-400">Build your battle deck</p>
        </div>
        <div class="flex gap-3">
            <TcgButton Variant="Secondary" OnClick="LoadDeck">
                <i class="fa fa-rotate-right mr-2"></i> Reset
            </TcgButton>
            <TcgButton Variant="Primary" OnClick="SaveDeck" Disabled="@(!IsValid)">
                <i class="fa fa-save mr-2"></i> Save Deck
            </TcgButton>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="mb-6 p-4 rounded-lg @MessageClass">
            @Message
        </div>
    }

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Commander -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fa fa-crown text-amber-400 mr-2"></i> Commander
                </h2>
                <TcgBadge Color="@(Commander != null ? "green" : "red")">
                    @(Commander != null ? "1/1" : "0/1")
                </TcgBadge>
            </div>
            
            @if (Commander != null)
            {
                <div class="aspect-[3/4] rounded-xl overflow-hidden border-2 border-amber-500/50 relative group cursor-pointer" @onclick="() => OpenCardPicker(DeckSection.Commander)">
                    <img src="/api/images/@Commander.ImagePath" alt="@Commander.Name" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex items-end p-3">
                        <p class="text-white font-medium">@Commander.Name</p>
                    </div>
                    <button class="absolute top-2 right-2 bg-red-500/80 hover:bg-red-500 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity" @onclick="() => RemoveCommander()" @onclick:stopPropagation="true">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            }
            else
            {
                <div class="aspect-[3/4] rounded-xl border-2 border-dashed border-slate-700 flex items-center justify-center cursor-pointer hover:border-amber-500/50 transition-colors" @onclick="() => OpenCardPicker(DeckSection.Commander)">
                    <div class="text-center text-slate-500">
                        <i class="fa fa-plus text-3xl mb-2"></i>
                        <p>Select Commander</p>
                    </div>
                </div>
            }
        </div>

        <!-- Main Deck -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fa fa-shield-halved text-blue-400 mr-2"></i> Main Deck
                </h2>
                <TcgBadge Color="@(MainDeck.Count == 9 ? "green" : MainDeck.Count > 9 ? "red" : "yellow")">
                    @(MainDeck.Count)/9
                </TcgBadge>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
                @for (int i = 0; i < 9; i++)
                {
                    var index = i;
                    if (index < MainDeck.Count)
                    {
                        var card = MainDeck[index];
                        <div class="aspect-[3/4] rounded-lg overflow-hidden border border-slate-700 relative group cursor-pointer" @onclick="() => OpenCardPicker(DeckSection.MainDeck, index)">
                            <img src="/api/images/@card.ImagePath" alt="@card.Name" class="w-full h-full object-cover">
                            <button class="absolute top-1 right-1 bg-red-500/80 hover:bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity text-xs" @onclick="() => RemoveFromMainDeck(index)" @onclick:stopPropagation="true">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="aspect-[3/4] rounded-lg border border-dashed border-slate-700 flex items-center justify-center cursor-pointer hover:border-blue-500/50 transition-colors" @onclick="() => OpenCardPicker(DeckSection.MainDeck, index)">
                            <i class="fa fa-plus text-slate-600"></i>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- Closer Deck -->
        <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <i class="fa fa-bolt text-purple-400 mr-2"></i> Closer Deck
                </h2>
                <TcgBadge Color="@(CloserDeck.Count == 3 ? "green" : CloserDeck.Count > 3 ? "red" : "yellow")">
                    @(CloserDeck.Count)/3
                </TcgBadge>
            </div>
            
            <div class="grid grid-cols-3 gap-2">
                @for (int i = 0; i < 3; i++)
                {
                    var index = i;
                    if (index < CloserDeck.Count)
                    {
                        var card = CloserDeck[index];
                        <div class="aspect-[3/4] rounded-lg overflow-hidden border border-slate-700 relative group cursor-pointer" @onclick="() => OpenCardPicker(DeckSection.Closer, index)">
                            <img src="/api/images/@card.ImagePath" alt="@card.Name" class="w-full h-full object-cover">
                            <button class="absolute top-1 right-1 bg-red-500/80 hover:bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity text-xs" @onclick="() => RemoveFromCloserDeck(index)" @onclick:stopPropagation="true">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="aspect-[3/4] rounded-lg border border-dashed border-slate-700 flex items-center justify-center cursor-pointer hover:border-purple-500/50 transition-colors" @onclick="() => OpenCardPicker(DeckSection.Closer, index)">
                            <i class="fa fa-plus text-slate-600"></i>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    @if (ShowCardPicker)
    {
        <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" @onclick="CloseCardPicker">
            <div class="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-4xl max-h-[80vh] overflow-hidden" @onclick:stopPropagation="true">
                <div class="p-4 border-b border-slate-700 flex items-center justify-between">
                    <h3 class="text-xl font-bold text-white">
                        Select @PickerSectionTitle
                    </h3>
                    <button class="text-slate-400 hover:text-white" @onclick="CloseCardPicker">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-4 border-b border-slate-800">
                    <input type="text" placeholder="Search your collection..." 
                        @bind="CardSearchQuery"
                        class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-2 text-white placeholder-slate-500">
                </div>

                <div class="p-4 overflow-y-auto max-h-[60vh]">
                    @if (FilteredCollectionCards.Count == 0)
                    {
                        <div class="text-center py-8 text-slate-500">
                            <i class="fa fa-box text-4xl mb-2 block"></i>
                            <p>No cards found in your collection</p>
                        </div>
                    }
                    else
                    {
                        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                            @foreach (var card in FilteredCollectionCards)
                            {
                                <div class="aspect-[3/4] rounded-lg overflow-hidden border-2 border-slate-700 hover:border-amber-500 cursor-pointer transition-colors relative group" @onclick="() => SelectCard(card)">
                                    @if (!string.IsNullOrEmpty(card.ImagePath))
                                    {
                                        <img src="/api/images/@card.ImagePath" alt="@card.Name" class="w-full h-full object-cover">
                                    }
                                    else
                                    {
                                        <div class="w-full h-full bg-gradient-to-br from-slate-600 to-slate-700 flex items-center justify-center">
                                            <i class="fa fa-image text-white opacity-30"></i>
                                        </div>
                                    }
                                    <div class="absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/90 to-transparent">
                                        <p class="text-white text-xs font-medium truncate">@card.Name</p>
                                        <p class="text-slate-400 text-xs">@card.CardType</p>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private Card? Commander { get; set; }
    private List<Card> MainDeck { get; set; } = new();
    private List<Card> CloserDeck { get; set; } = new();
    
    private List<UserCard> Collection { get; set; } = new();
    private bool IsLoading = true;
    private string Message = "";
    private string MessageClass = "";
    
    private bool ShowCardPicker;
    private DeckSection CurrentPickerSection;
    private int PickerSlotIndex;
    private string CardSearchQuery = "";

    private bool IsValid => Commander != null && MainDeck.Count == 9 && CloserDeck.Count == 3;

    private string PickerTitle => CurrentPickerSection switch
    {
        DeckSection.Commander => "Commander",
        DeckSection.MainDeck => "Main Deck Card",
        DeckSection.Closer => "Closer Card",
        _ => "Card"
    };

    private string PickerSectionTitle => CurrentPickerSection switch
    {
        DeckSection.Commander => "Commander (CardType.Commander)",
        DeckSection.MainDeck => "Unit Card (CardType.Unit)",
        DeckSection.Closer => "Closer Card (CardType.Closer)",
        _ => "Card"
    };

    private List<Card> FilteredCollectionCards
    {
        get
        {
            var requiredType = CurrentPickerSection switch
            {
                DeckSection.Commander => CardType.Commander,
                DeckSection.MainDeck => CardType.Unit,
                DeckSection.Closer => CardType.Closer,
                _ => (CardType?)null
            };

            var query = Collection
                .Where(uc => uc.Count > 0)
                .Select(uc => uc.Card)
                .Where(c => requiredType == null || c.CardType == requiredType)
                .Where(c => string.IsNullOrEmpty(CardSearchQuery) || c.Name.Contains(CardSearchQuery, StringComparison.OrdinalIgnoreCase));

            if (CurrentPickerSection == DeckSection.MainDeck)
            {
                var usedIds = MainDeck.Select(c => c.Id).ToList();
                query = query.Where(c => !usedIds.Contains(c.Id));
            }
            else if (CurrentPickerSection == DeckSection.Closer)
            {
                var usedIds = CloserDeck.Select(c => c.Id).ToList();
                query = query.Where(c => !usedIds.Contains(c.Id));
            }

            return query.ToList();
        }
    }

    private enum DeckSection
    {
        Commander,
        MainDeck,
        Closer
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadCollection();
        await LoadDeck();
    }

    private async Task LoadCollection()
    {
        var user = await AuthService.GetCurrentUserAsync();
        if (user != null)
        {
            Collection = await Client.GetCollectionAsync(user.Id);
        }
    }

    private async Task LoadDeck()
    {
        IsLoading = true;
        Message = "";
        try
        {
            var user = await AuthService.GetCurrentUserAsync();
            if (user != null)
            {
                var deck = await Client.GetDeckAsync(user.Id);
                if (deck != null)
                {
                    Commander = deck.Commander;
                    MainDeck = deck.DeckCards
                        .Where(dc => dc.Slot == DeckSlot.MainDeck)
                        .Select(dc => dc.Card)
                        .ToList();
                    CloserDeck = deck.DeckCards
                        .Where(dc => dc.Slot == DeckSlot.Closer)
                        .Select(dc => dc.Card)
                        .ToList();
                }
                else
                {
                    Commander = null;
                    MainDeck = new List<Card>();
                    CloserDeck = new List<Card>();
                }
            }
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SaveDeck()
    {
        if (!IsValid)
        {
            Message = "Please fill all deck slots before saving.";
            MessageClass = "bg-red-500/20 border border-red-500/50 text-red-400";
            return;
        }

        var user = await AuthService.GetCurrentUserAsync();
        if (user == null) return;

        var request = new HengcordTCGClient.SaveDeckRequest(
            user.Id,
            null,
            Commander!.Id,
            MainDeck.Select(c => c.Id).ToList(),
            CloserDeck.Select(c => c.Id).ToList()
        );

        var result = await Client.SaveDeckAsync(request);
        
        if (result.Success)
        {
            Message = result.Message;
            MessageClass = "bg-green-500/20 border border-green-500/50 text-green-400";
        }
        else
        {
            Message = result.Message;
            MessageClass = "bg-red-500/20 border border-red-500/50 text-red-400";
        }
    }

    private void OpenCardPicker(DeckSection section, int slotIndex = 0)
    {
        CurrentPickerSection = section;
        PickerSlotIndex = slotIndex;
        CardSearchQuery = "";
        ShowCardPicker = true;
    }

    private void CloseCardPicker()
    {
        ShowCardPicker = false;
    }

    private void SelectCard(Card card)
    {
        switch (CurrentPickerSection)
        {
            case DeckSection.Commander:
                Commander = card;
                break;
            case DeckSection.MainDeck:
                if (PickerSlotIndex < MainDeck.Count)
                    MainDeck[PickerSlotIndex] = card;
                else
                    MainDeck.Add(card);
                break;
            case DeckSection.Closer:
                if (PickerSlotIndex < CloserDeck.Count)
                    CloserDeck[PickerSlotIndex] = card;
                else
                    CloserDeck.Add(card);
                break;
        }
        CloseCardPicker();
    }

    private void RemoveCommander()
    {
        Commander = null;
    }

    private void RemoveFromMainDeck(int index)
    {
        if (index >= 0 && index < MainDeck.Count)
        {
            MainDeck.RemoveAt(index);
        }
    }

    private void RemoveFromCloserDeck(int index)
    {
        if (index >= 0 && index < CloserDeck.Count)
        {
            CloserDeck.RemoveAt(index);
        }
    }
}
