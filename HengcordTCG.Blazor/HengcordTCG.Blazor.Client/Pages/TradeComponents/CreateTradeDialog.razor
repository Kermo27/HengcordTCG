@inject ToastService Toast
@inject HengcordTCGClient Client

<Dialog @bind-Open="IsOpen">
    <DialogContent class="max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
            <DialogTitle class="text-slate-100">Create Trade</DialogTitle>
            <DialogDescription class="text-slate-400">
                Offer cards and gold in exchange for what you want
            </DialogDescription>
        </DialogHeader>
        
        <div class="grid md:grid-cols-2 gap-6 py-4">
            <div class="space-y-4">
                <h3 class="font-semibold text-slate-100 flex items-center">
                    <LucideIcon Name="arrow-up-from-line" Size="18" class="mr-2 text-emerald-400" />
                    You Offer
                </h3>
                
                <div>
                    <Label class="text-slate-400">Gold</Label>
                    <div class="flex items-center gap-2 mt-1">
                        <LucideIcon Name="coins" Size="18" class="text-amber-400" />
                        <Input 
                            @bind-Value="Model.OfferGoldString"
                            placeholder="0"
                            class="bg-slate-950 border-slate-700" />
                    </div>
                    <p class="text-xs text-slate-500 mt-1">Available: @AvailableGold.ToString("N0")</p>
                </div>

                <div>
                    <Label class="text-slate-400">Cards (comma-separated)</Label>
                    <Textarea 
                        @bind-Value="Model.OfferCards"
                        placeholder="Card1, Card2, Card3..."
                        class="mt-1 bg-slate-950 border-slate-700 min-h-[100px]" />
                </div>
            </div>

            <div class="space-y-4">
                <h3 class="font-semibold text-slate-100 flex items-center">
                    <LucideIcon Name="arrow-down-to-line" Size="18" class="mr-2 text-purple-400" />
                    You Want
                </h3>
                
                <div>
                    <Label class="text-slate-400">Target User ID</Label>
                    <Input 
                        @bind-Value="Model.TargetId"
                        placeholder="Discord User ID"
                        class="mt-1 bg-slate-950 border-slate-700" />
                </div>

                <div>
                    <Label class="text-slate-400">Gold</Label>
                    <div class="flex items-center gap-2 mt-1">
                        <LucideIcon Name="coins" Size="18" class="text-amber-400" />
                        <Input 
                            @bind-Value="Model.RequestGoldString"
                            placeholder="0"
                            class="bg-slate-950 border-slate-700" />
                    </div>
                </div>

                <div>
                    <Label class="text-slate-400">Cards (comma-separated)</Label>
                    <Textarea 
                        @bind-Value="Model.RequestCards"
                        placeholder="Card1, Card2, Card3..."
                        class="mt-1 bg-slate-950 border-slate-700 min-h-[100px]" />
                </div>
            </div>
        </div>

        <DialogFooter>
            <Button Variant="ButtonVariant.Outline" @onclick="OnCancel">Cancel</Button>
            <Button 
                @onclick="OnConfirm"
                Disabled="IsSaving"
                class="bg-gradient-to-r from-purple-500 to-pink-500">
                @if (IsSaving)
                {
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                }
                <LucideIcon Name="arrow-left-right" Size="18" class="mr-2" />
                Create Trade
            </Button>
        </DialogFooter>
    </DialogContent>
</Dialog>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public long AvailableGold { get; set; }
    [Parameter] public ulong CurrentUserId { get; set; }
    [Parameter] public string CurrentUsername { get; set; } = "";
    [Parameter] public EventCallback OnTradeCreated { get; set; }

    private bool IsSaving;
    private NewTradeModel Model { get; set; } = new();

    private void OnCancel()
    {
        IsOpen = false;
        Model = new();
    }

    private async Task OnConfirm()
    {
        if (!ulong.TryParse(Model.TargetId, out var targetId))
        {
            Toast.Error("Invalid target user ID");
            return;
        }

        IsSaving = true;
        try
        {
            var request = new HengcordTCGClient.CreateTradeRequest(
                CurrentUserId,
                CurrentUsername,
                targetId,
                "Target User",
                Model.OfferCards,
                Model.RequestCards
            );

            var result = await Client.CreateTradeAsync(request);
            
            if (result.Success)
            {
                Toast.Success("Trade created successfully!");
                IsOpen = false;
                Model = new();
                await OnTradeCreated.InvokeAsync();
            }
            else
            {
                Toast.Error(result.Message);
            }
        }
        catch
        {
            Toast.Error("Failed to create trade");
        }
        finally
        {
            IsSaving = false;
        }
    }

    private class NewTradeModel
    {
        public string TargetId { get; set; } = "";
        public string OfferGoldString { get; set; } = "0";
        public string RequestGoldString { get; set; } = "0";
        public string OfferCards { get; set; } = "";
        public string RequestCards { get; set; } = "";
    }
}
