@page "/collection"
@attribute [Authorize]
@inject HengcordTCGClient Client
@inject AuthService AuthService

<PageTitle>My Collection - HengcordTCG</PageTitle>

<div class="container py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">My Collection</h1>
        <p class="text-slate-400">@FilteredCards.Count cards collected</p>
    </div>

    <!-- Filters -->
    <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <input type="text" placeholder="Search cards..." 
                    @bind="SearchQuery"
                    class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-2 text-white placeholder-slate-500">
            </div>
            <div class="flex gap-2">
                <button @onclick="() => FilterType = null" 
                    class="px-4 py-2 rounded-lg @GetFilterClass(null)">
                    All (@Cards.Count)
                </button>
                @foreach (var type in Enum.GetValues<CardType>())
                {
                    <button @onclick="() => FilterType = type"
                        class="px-4 py-2 rounded-lg @GetFilterClass(type)">
                        @type (@Cards.Count(c => c.CardType == type))
                    </button>
                }
            </div>
        </div>
    </div>

    <!-- Cards Grid -->
    @if (IsLoading)
    {
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            @for (int i = 0; i < 10; i++)
            {
                <div class="aspect-[3/4] bg-slate-800 rounded-xl animate-pulse"></div>
            }
        </div>
    }
    else if (FilteredCards.Count == 0)
    {
        <div class="text-center py-16">
            <i class="fa fa-box text-6xl text-slate-600 mb-4 block"></i>
            <p class="text-slate-400">No cards found</p>
        </div>
    }
    else
    {
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            @foreach (var userCard in FilteredCards)
            {
                <div class="relative group">
                    <div class="aspect-[3/4] rounded-xl overflow-hidden border-2 @GetBorderClass(userCard.Rarity)">
                        @if (!string.IsNullOrEmpty(userCard.Card.ImagePath))
                        {
                            <img src="/api/images/@userCard.Card.ImagePath" alt="@userCard.Card.Name" class="w-full h-full object-cover">
                        }
                        else
                        {
                            <div class="w-full h-full bg-gradient-to-br @GetGradientClass(userCard.Rarity) flex items-center justify-center">
                                <i class="fa fa-image text-white opacity-30 text-4xl"></i>
                            </div>
                        }
                        @if (userCard.Count > 1)
                        {
                            <div class="absolute top-2 left-2 bg-slate-900/80 text-white px-2 py-1 rounded text-sm font-bold">
                                x@(userCard.Count)
                            </div>
                        }
                    </div>
                    <div class="absolute inset-x-0 bottom-0 p-2 bg-gradient-to-t from-black/90 to-transparent">
                        <p class="text-white text-sm font-medium truncate">@userCard.Card.Name</p>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<UserCard> Cards { get; set; } = new();
    private string SearchQuery = "";
    private CardType? FilterType;
    private bool IsLoading = true;

    private List<UserCard> FilteredCards => Cards
        .Where(c => (FilterType == null || c.Card.CardType == FilterType) &&
            (string.IsNullOrEmpty(SearchQuery) || c.Card.Name.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)))
        .OrderBy(c => c.Card.Name)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadCollection();
    }

    private async Task LoadCollection()
    {
        IsLoading = true;
        try
        {
            var user = await AuthService.GetCurrentUserAsync();
            if (user != null)
            {
                Cards = await Client.GetCollectionAsync(user.Id);
            }
        }
        finally
        {
            IsLoading = false;
        }
    }

    private string GetFilterClass(CardType? type) => FilterType == type 
        ? "bg-amber-500 text-white" 
        : "bg-slate-800 text-slate-300 hover:bg-slate-700";

    private string GetBorderClass(Rarity rarity) => rarity switch
    {
        Rarity.Legendary => "border-amber-500/50 shadow-lg shadow-amber-500/20",
        Rarity.Rare => "border-purple-500/50 shadow-lg shadow-purple-500/20",
        _ => "border-slate-700/50"
    };

    private string GetGradientClass(Rarity rarity) => rarity switch
    {
        Rarity.Legendary => "from-amber-600 to-orange-700",
        Rarity.Rare => "from-purple-600 to-blue-700",
        _ => "from-slate-600 to-slate-700"
    };
}
