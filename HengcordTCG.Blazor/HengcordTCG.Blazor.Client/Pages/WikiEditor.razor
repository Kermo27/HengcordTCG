@page "/wiki/new"
@page "/wiki/edit/{Slug}"
@using HengcordTCG.Shared.DTOs.Wiki
@using Markdig
@inject WikiService WikiService
@inject NavigationManager Navigation
@inject AuthService AuthService

<PageTitle>@(IsEditMode ? "Edit" : "New Page") - Wiki - HengcordTCG</PageTitle>

<div class="flex flex-col h-[calc(100vh-4rem)]">
    @* Top Bar *@
    <div class="flex items-center justify-between px-6 py-3 bg-slate-900/80 border-b border-slate-800">
        <div class="flex items-center gap-4">
            <a href="@(IsEditMode ? $"/wiki/{Slug}" : "/wiki")" class="text-slate-400 hover:text-white transition-colors">
                <i class="fa fa-arrow-left mr-2"></i>Back
            </a>
            <span class="text-slate-600">|</span>
            <h2 class="text-lg font-semibold text-white">
                <i class="fa @(IsEditMode ? "fa-edit" : "fa-plus") text-amber-400 mr-2"></i>
                @(IsEditMode ? "Edit Page" : "New Page")
            </h2>
        </div>
        <div class="flex items-center gap-3">
            @if (!string.IsNullOrEmpty(StatusMessage))
            {
                <span class="text-sm @(StatusSuccess ? "text-emerald-400" : "text-red-400")">@StatusMessage</span>
            }
            <a href="@(IsEditMode ? $"/wiki/{Slug}" : "/wiki")" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm transition-colors">
                Cancel
            </a>
            <button @onclick="SubmitAsync" disabled="@IsSaving" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 text-white rounded-lg text-sm font-medium transition-colors">
                @if (IsSaving)
                {
                    <i class="fa fa-spinner fa-spin mr-2"></i>
                }
                else
                {
                    <i class="fa fa-paper-plane mr-2"></i>
                }
                @(IsAdmin ? "Save" : "Submit Proposal")
            </button>
        </div>
    </div>

    @* Title Input *@
    <div class="px-6 py-3 bg-slate-900/50 border-b border-slate-800">
        <input @bind="Title"
               placeholder="Page title..."
               class="w-full bg-transparent text-2xl font-bold text-white placeholder-slate-600 outline-none" />
    </div>

    @* Split Pane: Editor + Preview *@
    <div class="flex flex-1 min-h-0">
        @* Left: Markdown Editor *@
        <div class="flex-1 flex flex-col min-w-0 border-r border-slate-800">
            <div class="px-4 py-2 bg-slate-900/50 border-b border-slate-800 flex items-center justify-between">
                <span class="text-xs font-medium text-slate-500 uppercase tracking-wider">
                    <i class="fa fa-code mr-1"></i> Markdown
                </span>
                <span class="text-xs text-slate-600">@Content.Length characters</span>
            </div>
            <div class="flex-1 min-h-0">
                <MarkdownEditor @bind-Value="Content" ShowPreview="false" />
            </div>
        </div>

        @* Right: Live Preview *@
        <div class="flex-1 flex flex-col min-w-0">
            <div class="px-4 py-2 bg-slate-900/50 border-b border-slate-800">
                <span class="text-xs font-medium text-slate-500 uppercase tracking-wider">
                    <i class="fa fa-eye mr-1"></i> Preview
                </span>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="max-w-none">
                    @if (!string.IsNullOrEmpty(Title))
                    {
                        <h1 class="text-3xl font-bold text-white mb-6">@Title</h1>
                    }
                    @if (!string.IsNullOrEmpty(Content))
                    {
                        <div class="prose prose-invert max-w-none text-slate-300 markdown-preview">
                            @((MarkupString)RenderMarkdown(Content))
                        </div>
                    }
                    else
                    {
                        <p class="text-slate-600 italic">Start typing to see a preview...</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public string? Slug { get; set; }

    private string Title = "";
    private string Content = "";
    private bool IsSaving;
    private string? StatusMessage;
    private bool StatusSuccess;
    
    private WikiPageDetailDto? ExistingPage;
    
    private bool IsEditMode => !string.IsNullOrEmpty(Slug);
    private bool IsAdmin => AuthService.GetCurrentUser()?.IsBotAdmin == true;

    private static readonly MarkdownPipeline Pipeline = new MarkdownPipelineBuilder()
        .UseAutoLinks()
        .UseTaskLists()
        .UseGridTables()
        .Build();

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            ExistingPage = await WikiService.GetPageAsync(Slug!);
            if (ExistingPage != null)
            {
                Title = ExistingPage.Title;
                Content = ExistingPage.Content;
            }
        }
    }

    private async Task SubmitAsync()
    {
        if (string.IsNullOrWhiteSpace(Title))
        {
            StatusMessage = "Title is required";
            StatusSuccess = false;
            return;
        }

        IsSaving = true;
        StatusMessage = null;

        try
        {
            if (IsAdmin)
            {
                // Admin: direct save
                if (IsEditMode && ExistingPage != null)
                {
                    await WikiService.UpdatePageAsync(ExistingPage.Id, new UpdateWikiPageRequest
                    {
                        Title = Title,
                        Content = Content,
                        ParentId = ExistingPage.ParentId,
                        Order = ExistingPage.Order
                    });
                }
                else
                {
                    await WikiService.CreatePageAsync(new CreateWikiPageRequest
                    {
                        Title = Title,
                        Content = Content
                    });
                }

                var slug = ExistingPage?.Slug ?? Title.ToLower().Replace(" ", "-");
                Navigation.NavigateTo($"/wiki/{slug}", forceLoad: true);
            }
            else
            {
                // Regular user: create proposal
                var type = IsEditMode
                    ? HengcordTCG.Shared.Models.ProposalType.Edit
                    : HengcordTCG.Shared.Models.ProposalType.NewPage;

                await WikiService.CreateProposalAsync(new CreateProposalRequest
                {
                    Type = type,
                    Title = Title,
                    Content = Content,
                    WikiPageId = ExistingPage?.Id
                });

                StatusMessage = "Proposal submitted for review!";
                StatusSuccess = true;
                
                await Task.Delay(1500);
                Navigation.NavigateTo(IsEditMode ? $"/wiki/{Slug}" : "/wiki");
            }
        }
        catch (Exception ex)
        {
            StatusMessage = $"Error: {ex.Message}";
            StatusSuccess = false;
        }
        finally
        {
            IsSaving = false;
        }
    }

    private static string RenderMarkdown(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        return Markdown.ToHtml(content, Pipeline);
    }
}
