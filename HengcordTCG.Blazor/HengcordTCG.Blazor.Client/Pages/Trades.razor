@page "/trades"
@attribute [Authorize]
@inject HengcordTCGClient Client
@inject AuthService AuthService
@inject ToastService Toast

<PageTitle>Trading - HengcordTCG</PageTitle>

<div class="container py-8">
    <PageHeader Title="Trading Center" Section="Trades" Subtitle="Trade cards with other players" />
    <div class="flex justify-end mb-6">
        <Button @onclick="() => ShowCreateTrade = true" class="bg-gradient-to-r from-purple-500 to-pink-500">
            <LucideIcon Name="plus" Size="18" class="mr-2" />
            Create Trade
        </Button>
    </div>

    <Tabs @bind-Value="_activeTab" class="w-full">
        <TabsList class="bg-slate-900 border border-slate-800">
            <TabsTrigger Value="active" class="data-[state=active]:bg-slate-800">Active Trades</TabsTrigger>
            <TabsTrigger Value="my" class="data-[state=active]:bg-slate-800">My Trades</TabsTrigger>
            <TabsTrigger Value="history" class="data-[state=active]:bg-slate-800">History</TabsTrigger>
        </TabsList>

        <TabsContent Value="active" class="mt-6">
            @if (!IsLoading && ActiveTrades.Any())
            {
                <div class="space-y-4">
                    @foreach (var trade in ActiveTrades)
                    {
                        <TradeCard Trade="trade" CurrentUserId="CurrentUserId" />
                    }
                </div>
            }
            else
            {
                <EmptyState Icon="arrow-left-right" Title="No Active Trades" Description="There are no active trades at the moment." />
            }
        </TabsContent>

        <TabsContent Value="my" class="mt-6">
            @if (!IsLoading && MyTrades.Any())
            {
                <div class="space-y-4">
                    @foreach (var trade in MyTrades)
                    {
                        <TradeCard Trade="trade" CurrentUserId="CurrentUserId" />
                    }
                </div>
            }
            else
            {
                <EmptyState Icon="package" Title="No Trades Yet" Description="You haven't created any trades yet." />
            }
        </TabsContent>

        <TabsContent Value="history" class="mt-6">
            <EmptyState Icon="history" Title="No Trade History" Description="Your completed trades will appear here." />
        </TabsContent>
    </Tabs>
</div>

@code {
    private string _activeTab = "active";
    private bool IsLoading = true;
    private ulong CurrentUserId { get; set; }
    private long CurrentGold { get; set; }

    private List<Trade> ActiveTrades { get; set; } = new();
    private List<Trade> MyTrades { get; set; } = new();

    private bool ShowCreateTrade { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        try
        {
            var user = await AuthService.GetCurrentUserAsync();
            if (user != null)
            {
                CurrentUserId = user.Id;
                CurrentGold = user.Gold;
            }

            var allTrades = await Client.GetTradesForUserAsync(CurrentUserId);
            ActiveTrades = allTrades.Where(t => t.Status == TradeStatus.Pending && t.TargetId != 0).ToList();
            MyTrades = allTrades.Where(t => t.Initiator?.DiscordId == CurrentUserId).ToList();
        }
        catch
        {
            Toast.Error("Failed to load trades");
        }
        finally
        {
            IsLoading = false;
        }
    }
}
