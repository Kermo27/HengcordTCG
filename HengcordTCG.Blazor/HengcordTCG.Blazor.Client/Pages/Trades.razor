@page "/trades"
@attribute [Authorize]
@inject HengcordTCGClient Client
@inject AuthService AuthService
@inject ToastService Toast
@inject NavigationManager Navigation

<PageTitle>Trading - HengcordTCG</PageTitle>

<div class="container py-8">
    <PageHeader Title="Trading Center" Section="Trades" Subtitle="Trade cards with other players" />
    <div class="flex justify-end mb-6">
        <Button @onclick="() => ShowCreateTrade = true" class="bg-gradient-to-r from-purple-500 to-pink-500">
            <LucideIcon Name="plus" Size="18" class="mr-2" />
            Create Trade
        </Button>
    </div>

    <Tabs @bind-Value="ActiveTab" class="w-full">
        <TabsList class="bg-slate-900 border border-slate-800">
            <TabsTrigger Value="active" class="data-[state=active]:bg-slate-800">Active Trades</TabsTrigger>
            <TabsTrigger Value="my" class="data-[state=active]:bg-slate-800">My Trades</TabsTrigger>
            <TabsTrigger Value="history" class="data-[state=active]:bg-slate-800">History</TabsTrigger>
        </TabsList>

        <TabsContent Value="active" class="mt-6">
            <TradeComponents.ActiveTradesTab 
                Trades="ActiveTrades"
                CurrentUserId="CurrentUserId"
                IsLoading="IsLoading"
                OnCreateTrade="() => ShowCreateTrade = true"
                OnAcceptTrade="AcceptTrade"
                OnRejectTrade="RejectTrade" />
        </TabsContent>

        <TabsContent Value="my" class="mt-6">
            <TradeComponents.MyTradesTab 
                Trades="MyTrades"
                CurrentUserId="CurrentUserId"
                IsLoading="IsLoading"
                OnCreateTrade="() => ShowCreateTrade = true"
                OnCancelTrade="CancelTrade" />
        </TabsContent>

        <TabsContent Value="history" class="mt-6">
            <EmptyState 
                Icon="history"
                Title="No Trade History"
                Description="Your completed trades will appear here." />
        </TabsContent>
    </Tabs>
</div>

<TradeComponents.CreateTradeDialog 
    IsOpen="ShowCreateTrade"
    AvailableGold="CurrentGold"
    CurrentUserId="CurrentUserId"
    CurrentUsername="CurrentUsername"
    OnTradeCreated="LoadData" />

@code {
    private string ActiveTab { get; set; } = "active";
    private bool IsLoading { get; set; } = true;
    private ulong CurrentUserId { get; set; }
    private string CurrentUsername { get; set; } = "";
    private long CurrentGold { get; set; }

    private List<Trade> ActiveTrades { get; set; } = new();
    private List<Trade> MyTrades { get; set; } = new();
    private bool ShowCreateTrade { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        try
        {
            var user = await AuthService.GetCurrentUserAsync();
            if (user != null)
            {
                CurrentUserId = user.Id;
                CurrentUsername = user.Username;
                CurrentGold = user.Gold;
            }

            var allTrades = await Client.GetTradesForUserAsync(CurrentUserId);
            ActiveTrades = allTrades.Where(t => t.Status == TradeStatus.Pending && t.TargetId != 0).ToList();
            MyTrades = allTrades.Where(t => t.Initiator?.DiscordId == CurrentUserId).ToList();
        }
        catch
        {
            Toast.Error("Failed to load trades");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task AcceptTrade(Trade trade)
    {
        var result = await Client.AcceptTradeAsync(trade.Id, CurrentUserId);
        if (result.Success)
        {
            Toast.Success("Trade accepted!");
            await LoadData();
        }
        else
        {
            Toast.Error(result.Message);
        }
    }

    private async Task RejectTrade(Trade trade)
    {
        var result = await Client.RejectTradeAsync(trade.Id, CurrentUserId);
        if (result.Success)
        {
            Toast.Success("Trade rejected");
            await LoadData();
        }
        else
        {
            Toast.Error(result.Message);
        }
    }

    private async Task CancelTrade(Trade trade)
    {
        var result = await Client.RejectTradeAsync(trade.Id, CurrentUserId);
        if (result.Success)
        {
            Toast.Success("Trade cancelled");
            await LoadData();
        }
        else
        {
            Toast.Error(result.Message);
        }
    }
}
