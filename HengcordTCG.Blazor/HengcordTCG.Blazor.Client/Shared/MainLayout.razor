@implements IDisposable
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="min-h-screen flex flex-col bg-slate-950 text-slate-50">
    <!-- Header -->
    <header class="sticky top-0 z-50 w-full border-b border-slate-800 bg-slate-950/80 backdrop-blur">
        <div class="container flex h-16 items-center">
            <!-- Mobile Menu Button -->
            <button @onclick="ToggleMobileMenu" class="md:hidden mr-2 p-2 text-slate-400 hover:text-white">
                <i class="fa fa-bars text-xl"></i>
            </button>

            <!-- Logo -->
            <div class="mr-4 flex">
                <a href="/" class="mr-6 flex items-center space-x-2 group">
                    <div class="relative">
                        <i class="fa fa-sparkles text-amber-400 text-2xl"></i>
                    </div>
                    <span class="font-bold text-xl bg-gradient-to-r from-amber-400 to-purple-500 bg-clip-text text-transparent">
                        HengcordTCG
                    </span>
                </a>
            </div>

            <!-- Desktop Navigation -->
            <nav class="hidden md:flex items-center space-x-1">
                <NavLink href="/" Match="NavLinkMatch.All" class="@NavLinkClass("/")">
                    <i class="fa fa-home mr-2"></i> Home
                </NavLink>
                <NavLink href="/collection" class="@NavLinkClass("/collection")">
                    <i class="fa fa-layer-group mr-2"></i> Collection
                </NavLink>
                <NavLink href="/gallery" class="@NavLinkClass("/gallery")">
                    <i class="fa fa-images mr-2"></i> Gallery
                </NavLink>
                <NavLink href="/shop" class="@NavLinkClass("/shop")">
                    <i class="fa fa-shopping-bag mr-2"></i> Shop
                </NavLink>
                <NavLink href="/trades" class="@NavLinkClass("/trades")">
                    <i class="fa fa-arrow-right-arrow-left mr-2"></i> Trades
                </NavLink>
                <NavLink href="/wiki" class="@NavLinkClass("/wiki")">
                    <i class="fa fa-book-open mr-2"></i> Wiki
                </NavLink>
                <AuthorizeView Roles="Admin">
                    <NavLink href="/admin" class="@NavLinkClass("/admin") text-amber-400">
                        <i class="fa fa-shield mr-2"></i> Admin
                    </NavLink>
                </AuthorizeView>
            </nav>

            <!-- Right side -->
            <div class="flex flex-1 items-center justify-end space-x-4">
                <!-- Gold Display -->
                <AuthorizeView>
                    <Authorized>
                        <div class="hidden sm:flex items-center space-x-2 px-3 py-1.5 rounded-full bg-amber-500/10 border border-amber-500/20">
                            <i class="fa fa-coins text-amber-400"></i>
                            <span class="text-amber-400 font-semibold">@Gold.ToString("N0")</span>
                        </div>
                    </Authorized>
                </AuthorizeView>

                <!-- User Menu -->
                <AuthorizeView>
                    <Authorized>
                        <div class="relative">
                            <button @onclick="ToggleUserMenu" class="flex items-center gap-2">
                                <div class="h-9 w-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-semibold text-sm">
                                    @(Username?.FirstOrDefault().ToString().ToUpper() ?? "U")
                                </div>
                            </button>
                            @if (ShowUserMenu)
                            {
                                <div class="absolute right-0 mt-2 w-56 bg-slate-900 border border-slate-700 rounded-lg shadow-lg z-50">
                                    <div class="p-3 border-b border-slate-700">
                                        <p class="font-medium">@Username</p>
                                        <p class="text-sm text-slate-400">@Gold.ToString("N0") Gold</p>
                                    </div>
                                    <div class="p-1">
                                        <a href="/collection" @onclick="() => ShowUserMenu = false" class="flex items-center px-3 py-2 text-slate-300 hover:bg-slate-800 rounded">
                                            <i class="fa fa-layer-group mr-2 w-4"></i> My Collection
                                        </a>
                                        <button @onclick="Logout" class="w-full flex items-center px-3 py-2 text-red-400 hover:bg-slate-800 rounded">
                                            <i class="fa fa-sign-out-alt mr-2 w-4"></i> Log out
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <button @onclick="Login" class="bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 px-4 py-2 rounded-lg font-medium">
                            <i class="fa fa-sign-in-alt mr-2"></i> Login with Discord
                        </button>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 pb-20 md:pb-0">
        @Body
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 z-40 md:hidden border-t border-slate-800 bg-slate-950/95 backdrop-blur">
        <div class="flex items-center justify-around h-16">
            <a href="/" class="bottom-nav-item @BottomNavClass("/")">
                <i class="fa fa-home text-xl"></i>
                <span class="text-xs">Home</span>
            </a>
            <a href="/collection" class="bottom-nav-item @BottomNavClass("/collection")">
                <i class="fa fa-layer-group text-xl"></i>
                <span class="text-xs">Collection</span>
            </a>
            <a href="/shop" class="bottom-nav-item @BottomNavClass("/shop")">
                <i class="fa fa-shopping-bag text-xl"></i>
                <span class="text-xs">Shop</span>
            </a>
            <a href="/trades" class="bottom-nav-item @BottomNavClass("/trades")">
                <i class="fa fa-arrow-right-arrow-left text-xl"></i>
                <span class="text-xs">Trades</span>
            </a>
            <a href="/gallery" class="bottom-nav-item @BottomNavClass("/gallery")">
                <i class="fa fa-images text-xl"></i>
                <span class="text-xs">Gallery</span>
            </a>
        </div>
    </nav>
</div>

<style>
    .nav-link {
        @apply px-3 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors;
    }
    .nav-link-active {
        @apply text-amber-400 bg-slate-800;
    }
    .bottom-nav-item {
        @apply flex flex-col items-center justify-center w-16 text-slate-500 transition-colors;
    }
    .bottom-nav-item-active {
        @apply text-amber-400;
    }
</style>

@code {
    private string? Username { get; set; }
    private long Gold { get; set; }
    private bool ShowUserMenu { get; set; }
    private string CurrentPath => new Uri(Navigation.Uri).AbsolutePath;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var user = await AuthService.InitializeAsync();
            if (user != null)
            {
                Username = user.Username;
                Gold = user.Gold;
                StateHasChanged();
            }
        }
    }

    private void ToggleUserMenu() => ShowUserMenu = !ShowUserMenu;
    private void ToggleMobileMenu() { }

    private void Login()
    {
        var loginUrl = AuthService.GetDiscordLoginUrl();
        Navigation.NavigateTo(loginUrl, forceLoad: true);
    }

    private async Task Logout()
    {
        ShowUserMenu = false;
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/");
    }

    private string NavLinkClass(string path) => 
        CurrentPath == path || CurrentPath.StartsWith(path) 
            ? "nav-link-active" 
            : "nav-link";

    private string BottomNavClass(string path) => 
        CurrentPath == path || CurrentPath.StartsWith(path) 
            ? "bottom-nav-item-active" 
            : "";

    public void Dispose()
    {
    }
}
