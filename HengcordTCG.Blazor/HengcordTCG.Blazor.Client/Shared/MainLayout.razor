@inherits LayoutComponentBase
@implements IDisposable
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="relative min-h-screen flex flex-col bg-slate-950 text-slate-50">
        <!-- Header -->
        <header class="sticky top-0 z-50 w-full border-b border-slate-800 bg-slate-950/80 backdrop-blur supports-[backdrop-filter]:bg-slate-950/60">
            <div class="container flex h-16 items-center">
                <!-- Mobile Menu Button -->
                <Button @onclick="ToggleMobileMenu" Variant="ButtonVariant.Ghost" class="md:hidden mr-2 p-2 text-slate-400 hover:text-white">
                    <LucideIcon Name="menu" Size="24" />
                </Button>

                <!-- Logo -->
                <div class="mr-4 flex">
                    <a href="/" class="mr-6 flex items-center space-x-2 group">
                        <div class="relative">
                            <LucideIcon Name="sparkles" Size="28" class="text-amber-400 group-hover:text-amber-300 transition-colors" />
                        </div>
                        <span class="font-bold text-xl bg-gradient-to-r from-amber-400 to-purple-500 bg-clip-text text-transparent">
                            HengcordTCG
                        </span>
                    </a>
                </div>

                <!-- Desktop Navigation -->
                <nav class="hidden md:flex items-center space-x-1">
                    <NavLink href="/" Match="NavLinkMatch.All" class="nav-link" ActiveClass="nav-link-active">
                        <LucideIcon Name="home" Size="18" class="mr-2" />
                        Home
                    </NavLink>
                    <NavLink href="/collection" class="nav-link" ActiveClass="nav-link-active">
                        <LucideIcon Name="layers" Size="18" class="mr-2" />
                        Collection
                    </NavLink>
                    <NavLink href="/gallery" class="nav-link" ActiveClass="nav-link-active">
                        <LucideIcon Name="images" Size="18" class="mr-2" />
                        Gallery
                    </NavLink>
                    <NavLink href="/shop" class="nav-link" ActiveClass="nav-link-active">
                        <LucideIcon Name="shopping-bag" Size="18" class="mr-2" />
                        Shop
                    </NavLink>
                    <NavLink href="/trades" class="nav-link" ActiveClass="nav-link-active">
                        <LucideIcon Name="arrow-left-right" Size="18" class="mr-2" />
                        Trades
                    </NavLink>
                    <NavLink href="/wiki" class="nav-link" ActiveClass="nav-link-active">
                        <LucideIcon Name="book-open" Size="18" class="mr-2" />
                        Wiki
                    </NavLink>
                    <AuthorizeView Roles="Admin">
                        <NavLink href="/admin" class="nav-link text-amber-400" ActiveClass="nav-link-active text-amber-400">
                            <LucideIcon Name="shield" Size="18" class="mr-2" />
                            Admin
                        </NavLink>
                    </AuthorizeView>
                </nav>

                <!-- Right side -->
                <div class="flex flex-1 items-center justify-end space-x-4">
                    <!-- Gold Display -->
                    <AuthorizeView>
                        <Authorized>
                            <div class="hidden sm:flex items-center space-x-2 px-3 py-1.5 rounded-full bg-amber-500/10 border border-amber-500/20">
                                <LucideIcon Name="coins" Size="16" class="text-amber-400" />
                                <span class="text-amber-400 font-semibold">@Gold.ToString("N0")</span>
                            </div>
                        </Authorized>
                    </AuthorizeView>

                    <!-- User Menu -->
                    <AuthorizeView>
                        <Authorized>
                            <DropdownMenu>
                                <DropdownMenuTrigger>
                                    <Avatar class="h-9 w-9 cursor-pointer ring-2 ring-slate-700 hover:ring-slate-500 transition-all">
                                        @if (!string.IsNullOrEmpty(AvatarUrl))
                                        {
                                            <AvatarImage Source="@AvatarUrl" Alt="@Username" />
                                        }
                                        <AvatarFallback class="bg-gradient-to-br from-purple-500 to-pink-500 text-white font-semibold text-sm">
                                            @(Username?.FirstOrDefault().ToString().ToUpper() ?? "U")
                                        </AvatarFallback>
                                    </Avatar>
                                </DropdownMenuTrigger>
                                <DropdownMenuContent class="w-56">
                                    <DropdownMenuLabel class="font-normal">
                                        <div class="flex flex-col space-y-1">
                                            <p class="text-sm font-medium">@Username</p>
                                            <p class="text-xs text-muted-foreground">@Gold.ToString("N0") Gold</p>
                                        </div>
                                    </DropdownMenuLabel>
                                    <DropdownMenuSeparator />
                                    <DropdownMenuItem @onclick="GoToProfile">
                                        <LucideIcon Name="user" Size="16" class="mr-2" />
                                        Profile
                                    </DropdownMenuItem>
                                    <DropdownMenuItem @onclick="GoToCollection">
                                        <LucideIcon Name="layers" Size="16" class="mr-2" />
                                        My Collection
                                    </DropdownMenuItem>
                                    <DropdownMenuSeparator />
                                    <DropdownMenuItem @onclick="Logout" class="text-red-400 focus:text-red-400">
                                        <LucideIcon Name="log-out" Size="16" class="mr-2" />
                                        Log out
                                    </DropdownMenuItem>
                                </DropdownMenuContent>
                            </DropdownMenu>
                        </Authorized>
                        <NotAuthorized>
                            <Button @onclick="Login" class="bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600">
                                <LucideIcon Name="log-in" Size="18" class="mr-2" />
                                Login with Discord
                            </Button>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </div>
        </header>

        <!-- Mobile Side Menu -->
        <Sheet @bind-Open="IsMobileMenuOpen" Side="BlazorBlueprint.Primitives.Sheet.SheetSide.Left">
            <SheetContent class="w-72 bg-slate-950 border-slate-800 p-0">
                <SheetHeader class="p-6 border-b border-slate-800">
                    <SheetTitle class="text-left">
                        <span class="font-bold text-lg bg-gradient-to-r from-amber-400 to-purple-500 bg-clip-text text-transparent">
                            HengcordTCG
                        </span>
                    </SheetTitle>
                </SheetHeader>
                <nav class="flex flex-col p-4 space-y-1">
                    <a href="/" @onclick="CloseMobileMenu" class="mobile-nav-link @GetMobileActiveClass("/", true)">
                        <LucideIcon Name="home" Size="20" class="mr-3" />
                        Home
                    </a>
                    <a href="/collection" @onclick="CloseMobileMenu" class="mobile-nav-link @GetMobileActiveClass("/collection")">
                        <LucideIcon Name="layers" Size="20" class="mr-3" />
                        Collection
                    </a>
                    <a href="/gallery" @onclick="CloseMobileMenu" class="mobile-nav-link @GetMobileActiveClass("/gallery")">
                        <LucideIcon Name="images" Size="20" class="mr-3" />
                        Gallery
                    </a>
                    <a href="/shop" @onclick="CloseMobileMenu" class="mobile-nav-link @GetMobileActiveClass("/shop")">
                        <LucideIcon Name="shopping-bag" Size="20" class="mr-3" />
                        Shop
                    </a>
                    <a href="/trades" @onclick="CloseMobileMenu" class="mobile-nav-link @GetMobileActiveClass("/trades")">
                        <LucideIcon Name="arrow-left-right" Size="20" class="mr-3" />
                        Trades
                    </a>
                    <a href="/wiki" @onclick="CloseMobileMenu" class="mobile-nav-link @GetMobileActiveClass("/wiki")">
                        <LucideIcon Name="book-open" Size="20" class="mr-3" />
                        Wiki
                    </a>
                    <AuthorizeView Roles="Admin">
                        <div class="pt-2 mt-2 border-t border-slate-800">
                            <a href="/admin" @onclick="CloseMobileMenu" class="mobile-nav-link text-amber-400 @GetMobileActiveClass("/admin")">
                                <LucideIcon Name="shield" Size="20" class="mr-3" />
                                Admin
                            </a>
                        </div>
                    </AuthorizeView>
                </nav>

                <!-- Mobile Gold Display -->
                <AuthorizeView>
                    <Authorized>
                        <div class="mx-4 mt-auto p-4 rounded-xl bg-amber-500/10 border border-amber-500/20">
                            <div class="flex items-center gap-2">
                                <LucideIcon Name="coins" Size="20" class="text-amber-400" />
                                <span class="text-amber-400 font-bold text-lg">@Gold.ToString("N0")</span>
                                <span class="text-amber-400/60 text-sm">Gold</span>
                            </div>
                        </div>
                    </Authorized>
                </AuthorizeView>
            </SheetContent>
        </Sheet>

        <!-- Main Content -->
        <main class="flex-1 pb-20 md:pb-0">
            @Body
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 z-40 md:hidden border-t border-slate-800 bg-slate-950/95 backdrop-blur">
            <div class="flex items-center justify-around h-16">
                <a href="/" class="bottom-nav-item @GetBottomNavActive("/", true)">
                    <LucideIcon Name="home" Size="22" />
                    <span class="text-[10px] mt-0.5">Home</span>
                </a>
                <a href="/collection" class="bottom-nav-item @GetBottomNavActive("/collection")">
                    <LucideIcon Name="layers" Size="22" />
                    <span class="text-[10px] mt-0.5">Collection</span>
                </a>
                <a href="/shop" class="bottom-nav-item @GetBottomNavActive("/shop")">
                    <LucideIcon Name="shopping-bag" Size="22" />
                    <span class="text-[10px] mt-0.5">Shop</span>
                </a>
                <a href="/trades" class="bottom-nav-item @GetBottomNavActive("/trades")">
                    <LucideIcon Name="arrow-left-right" Size="22" />
                    <span class="text-[10px] mt-0.5">Trades</span>
                </a>
                <a href="/gallery" class="bottom-nav-item @GetBottomNavActive("/gallery")">
                    <LucideIcon Name="images" Size="22" />
                    <span class="text-[10px] mt-0.5">Gallery</span>
                </a>
            </div>
        </nav>

        <!-- Footer (hidden on mobile, bottom nav takes its place) -->
        <footer class="hidden md:block border-t border-slate-800 py-6 bg-slate-950">
            <div class="container flex flex-col md:flex-row items-center justify-between gap-4">
                <p class="text-sm text-slate-500">
                    @DateTime.Now.Year HengcordTCG. All rights reserved.
                </p>
                <div class="flex items-center space-x-6">
                    <a href="https://discord.com" target="_blank" class="text-slate-500 hover:text-slate-300 transition-colors">
                        <LucideIcon Name="message-circle" Size="20" />
                    </a>
                    <a href="https://github.com" target="_blank" class="text-slate-500 hover:text-slate-300 transition-colors">
                        <LucideIcon Name="github" Size="20" />
                    </a>
                </div>
            </div>
        </footer>
    </div>

    <ToastProvider Position="ToastPosition.TopRight" />
    <PortalHost />

@code {
    private string? Username { get; set; }
    private string? AvatarUrl { get; set; }
    private long Gold { get; set; }
    private bool IsMobileMenuOpen { get; set; }
    private string CurrentPath => new Uri(Navigation.Uri).AbsolutePath;

    protected override void OnInitialized()
    {
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        Navigation.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var user = await AuthService.InitializeAsync();
            
            if (user != null)
            {
                Username = user.Username;
                AvatarUrl = user.AvatarUrl;
                Gold = user.Gold;
                StateHasChanged();
            }
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        var authState = await task;
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            var userInfo = await AuthService.GetCurrentUserAsync();
            if (userInfo != null)
            {
                Username = userInfo.Username;
                AvatarUrl = userInfo.AvatarUrl;
                Gold = userInfo.Gold;
                await InvokeAsync(StateHasChanged);
            }
        }
        else
        {
            Username = null;
            AvatarUrl = null;
            Gold = 0;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        IsMobileMenuOpen = false;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        Navigation.LocationChanged -= OnLocationChanged;
    }

    private void ToggleMobileMenu() => IsMobileMenuOpen = !IsMobileMenuOpen;
    private void CloseMobileMenu() => IsMobileMenuOpen = false;

    private void Login()
    {
        var loginUrl = AuthService.GetDiscordLoginUrl();
        Navigation.NavigateTo(loginUrl, forceLoad: true);
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/");
    }

    private void GoToProfile() => Navigation.NavigateTo("/profile");
    private void GoToCollection() => Navigation.NavigateTo("/collection");

    private bool IsActive(string path, bool exact = false) =>
        exact ? CurrentPath == path : CurrentPath.StartsWith(path, StringComparison.OrdinalIgnoreCase);

    private string GetMobileActiveClass(string path, bool exact = false) =>
        IsActive(path, exact) ? "bg-slate-800 text-white" : "";

    private string GetBottomNavActive(string path, bool exact = false) =>
        IsActive(path, exact) ? "text-amber-400" : "text-slate-500";
}
